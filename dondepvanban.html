<!DOCTYPE html>
<html lang="vi" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Th·∫ª meta PWA -->
    <meta name="theme-color" content="#78350f"/>
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/images/icons/icon-192x192.png">
    <title>D·ªçn D·∫πp VƒÉn B·∫£n</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        html {
            -webkit-tap-highlight-color: transparent;
        }
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior-y: none; /* NgƒÉn ch·∫∑n pull-to-refresh tr√™n mobile */
        }
        /* T√πy ch·ªânh thanh cu·ªôn cho ƒë·∫πp h∆°n */
        textarea::-webkit-scrollbar {
            width: 8px;
        }
        textarea::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }
        textarea::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 10px;
        }
        textarea::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        /* ƒê·∫£m b·∫£o textarea co gi√£n ƒë√∫ng c√°ch trong flex/grid */
        .textarea-container {
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        .textarea-container textarea {
            flex-grow: 1;
            min-height: 150px; /* Chi·ªÅu cao t·ªëi thi·ªÉu cho mobile */
        }
    </style>
</head>
<body class="h-full flex flex-col bg-slate-100">

    <!-- V√πng n·ªôi dung ch√≠nh, c√≥ th·ªÉ cu·ªôn -->
    <main class="flex-grow p-2 sm:p-4 overflow-y-auto">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 h-full">
            
            <!-- V√πng nh·∫≠p li·ªáu -->
            <div class="textarea-container bg-white rounded-xl shadow-sm border border-slate-200">
                <label for="inputText" class="block text-base font-semibold text-slate-800 p-3 border-b border-slate-200">VƒÉn b·∫£n g·ªëc</label>
                <textarea id="inputText" class="w-full p-3 bg-transparent rounded-b-xl focus:outline-none resize-none" placeholder="D√°n vƒÉn b·∫£n c·ªßa b·∫°n v√†o ƒë√¢y..."></textarea>
            </div>

            <!-- V√πng k·∫øt qu·∫£ -->
            <div class="textarea-container bg-white rounded-xl shadow-sm border border-slate-200">
                <label for="outputText" class="block text-base font-semibold text-slate-800 p-3 border-b border-slate-200">K·∫øt qu·∫£</label>
                <textarea id="outputText" readonly class="w-full p-3 bg-slate-50 rounded-b-xl focus:outline-none resize-none"></textarea>
            </div>

        </div>
    </main>

    <!-- Thanh menu ƒëi·ªÅu khi·ªÉn c·ªë ƒë·ªãnh -->
    <footer class="flex-shrink-0 bg-white/70 backdrop-blur-sm border-t border-slate-200 shadow-t-lg">
        <div class="max-w-4xl mx-auto grid grid-cols-2 sm:grid-cols-4 gap-2 sm:gap-3 p-2">
            <button id="formatButton" title="Tr√¨nh b√†y" class="bg-purple-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-700 active:scale-95 transition-all duration-150 shadow-sm flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>
                <span class="hidden sm:inline">Tr√¨nh b√†y</span>
            </button>
            <button id="cleanButton" title="L√†m s·∫°ch" class="bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 active:scale-95 transition-all duration-150 shadow-sm flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L14.5 8.5L21 10L14.5 11.5L12 18L9.5 11.5L3 10L9.5 8.5L12 2Z"/><path d="M4 2L5 4"/><path d="M19 13L20 15"/><path d="M2 17L3 15"/><path d="M12 22L11 20"/></svg>
                <span class="hidden sm:inline">L√†m s·∫°ch</span>
            </button>
            <button id="copyButton" title="Sao ch√©p" class="bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 active:scale-95 transition-all duration-150 shadow-sm flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                <span class="hidden sm:inline">Sao ch√©p</span>
            </button>
            <button id="clearAllButton" title="X√≥a h·∫øt" class="bg-red-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-700 active:scale-95 transition-all duration-150 shadow-sm flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                <span class="hidden sm:inline">X√≥a h·∫øt</span>
            </button>
        </div>
    </footer>

    <!-- Th√¥ng b√°o nhanh (Toast) -->
    <div id="toast" class="fixed bottom-20 right-5 bg-slate-800 text-white py-2 px-5 rounded-lg shadow-xl opacity-0 translate-y-3 transition-all duration-300 pointer-events-none">
        ƒê√£ sao ch√©p v√†o clipboard!
    </div>

    <script>
        // L·∫•y c√°c ph·∫ßn t·ª≠ DOM
        const inputText = document.getElementById('inputText');
        const outputText = document.getElementById('outputText');
        const formatButton = document.getElementById('formatButton');
        const cleanButton = document.getElementById('cleanButton');
        const copyButton = document.getElementById('copyButton');
        const clearAllButton = document.getElementById('clearAllButton');
        const toast = document.getElementById('toast');

        /**
         * Ch·ª©c nƒÉng tr√¨nh b√†y vƒÉn b·∫£n
         */
        function formatText(text) {
            const lines = text.split('\n');
            const vietnameseLines = [];
            const chineseLines = [];
            const sourceLines = [];

            const chineseRegex = /[\u4e00-\u9fa5]/;
            const sourceRegex = /^(wenda|zongshu|shuohua)/i;

            lines.forEach(line => {
                const trimmedLine = line.trim();
                if (sourceRegex.test(trimmedLine)) {
                    sourceLines.push(line);
                } else if (chineseRegex.test(line)) {
                    chineseLines.push(line);
                } else if (trimmedLine !== '') {
                    vietnameseLines.push(line);
                }
            });

            const blocks = [];
            if (vietnameseLines.length > 0) blocks.push(vietnameseLines.join('\n').trim());
            if (sourceLines.length > 0) blocks.push(sourceLines.join('\n').trim());
            if (chineseLines.length > 0) blocks.push(chineseLines.join('\n').trim());
            
            return blocks.join('\n\n');
        }

        /**
         * L√†m s·∫°ch vƒÉn b·∫£n (ƒê√£ c·∫≠p nh·∫≠t to√†n di·ªán)
         */
        function cleanText(text) {
            // --- B∆Ø·ªöC 1: B·∫¢O V·ªÜ URL ---
            const urlRegex = /(?:(?:https?|ftp):\/\/|www\.)[^\s/$.?#].[^\s]*/gi;
            const urlMap = new Map();
            let placeholderIndex = 0;

            const textWithPlaceholders = text.replace(urlRegex, (url) => {
                const placeholder = `URLPLACEHOLDER${placeholderIndex}`;
                urlMap.set(placeholder, url);
                placeholderIndex++;
                return placeholder;
            });

            // --- B∆Ø·ªöC 2: X·ª¨ L√ù T·ª™NG D√íNG ---
            const lines = textWithPlaceholders.split('\n');
            const cleanedLines = lines.map(line => {
                let cleanedLine = line;

                // --- LOGIC D·ªåN D·∫∏P EMOJI/SMILEY (PHI√äN B·∫¢N 3.0) ---
                // Logic n√†y ƒë∆∞·ª£c thi·∫øt k·∫ø l·∫°i ƒë·ªÉ x·ª≠ l√Ω c√°c tr∆∞·ªùng h·ª£p ph·ª©c t·∫°p m·ªôt c√°ch ch√≠nh x√°c h∆°n.

                // 2a. ƒê·ªãnh nghƒ©a c√°c m·∫´u c∆° b·∫£n
                const emojiPattern = `\\p{Emoji_Presentation}|\\p{Extended_Pictographic}`;
                // Smileys "an to√†n" (kh√¥ng d√πng d·∫•u ngo·∫∑c ƒë∆°n c·ªßa vƒÉn b·∫£n)
                const safeSmileys = `;-?\\)|:-?D|:-?P|XD`;
                // Smiley m·∫∑t c∆∞·ªùi :)
                const happySmiley = `:-?\\)`;
                // Smiley m·∫∑t bu·ªìn :( - c·∫ßn tho√°t k√Ω t·ª± `(`
                const sadSmiley = `:-?\\(`;

                // 2b. X√≥a emoji v√† c√°c smiley an to√†n (c√πng v·ªõi d·∫•u hai ch·∫•m n·∫øu c√≥)
                // V√≠ d·ª•: "üëç:", "XD", ";)"
                const emojiAndSafeSmileyPattern = new RegExp(`(?:${emojiPattern}|${safeSmileys})\\s*:?`, 'gu');
                cleanedLine = cleanedLine.replace(emojiAndSafeSmileyPattern, '');
                
                // 2c. X√≥a smiley m·∫∑t c∆∞·ªùi (c√πng v·ªõi d·∫•u hai ch·∫•m n·∫øu c√≥)
                // V√≠ d·ª•: ":)", ":-):"
                const happySmileyPattern = new RegExp(`${happySmiley}\\s*:?`, 'g');
                cleanedLine = cleanedLine.replace(happySmileyPattern, '');
                
                // 2d. X·ª≠ l√Ω ƒë·∫∑c bi·ªát cho smiley m·∫∑t bu·ªìn
                // Thay th·∫ø ":(" ho·∫∑c ":-(" b·∫±ng "(", ƒë·ªÉ gi·ªØ l·∫°i d·∫•u ngo·∫∑c c·ªßa vƒÉn b·∫£n.
                // V√≠ d·ª•: "‚òéÔ∏è:(·ªí)" -> "‚òéÔ∏è(·ªí)" (sau b∆∞·ªõc 2b) -> "(·ªí)" (sau b∆∞·ªõc 2d)
                // V√≠ d·ª•: ":(·ªí)" -> "(·ªí)"
                const sadSmileyPattern = new RegExp(sadSmiley, 'g');
                cleanedLine = cleanedLine.replace(sadSmileyPattern, '(');

                // 2e. D·ªçn d·∫πp c√°c kho·∫£ng tr·∫Øng th·ª´a c√≥ th·ªÉ xu·∫•t hi·ªán sau khi x√≥a.
                cleanedLine = cleanedLine.replace(/\s+/g, ' ').trim();
                
                return cleanedLine;
            });
            
            // --- B∆Ø·ªöC 3: GH√âP D√íNG V√Ä KH√îI PH·ª§C URL ---
            let cleanedTextWithPlaceholders = cleanedLines.join('\n');

            for (const [placeholder, url] of urlMap.entries()) {
                const placeholderRegex = new RegExp(placeholder.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), 'g');
                cleanedTextWithPlaceholders = cleanedTextWithPlaceholders.replace(placeholderRegex, url);
            }
            
            return cleanedTextWithPlaceholders;
        }

        // G√°n s·ª± ki·ªán cho n√∫t "Tr√¨nh b√†y"
        formatButton.addEventListener('click', () => {
            const originalText = inputText.value;
            const formattedText = formatText(originalText);
            outputText.value = formattedText;
        });

        // G√°n s·ª± ki·ªán cho n√∫t "L√†m s·∫°ch"
        cleanButton.addEventListener('click', () => {
            const textToClean = outputText.value || inputText.value;
            const cleanedText = cleanText(textToClean);
            outputText.value = cleanedText;
        });

        // G√°n s·ª± ki·ªán cho n√∫t "Sao ch√©p"
        copyButton.addEventListener('click', () => {
            if (outputText.value) {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(outputText.value).then(showToast).catch(copyFallback);
                } else {
                    copyFallback();
                }
            }
        });
        
        // Ph∆∞∆°ng √°n sao ch√©p d·ª± ph√≤ng
        function copyFallback() {
             const tempTextArea = document.createElement('textarea');
            tempTextArea.value = outputText.value;
            tempTextArea.style.position = 'absolute';
            tempTextArea.style.left = '-9999px';
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            try {
                document.execCommand('copy');
                showToast();
            } catch (err) {
                console.error('L·ªói sao ch√©p (fallback): ', err);
            }
            document.body.removeChild(tempTextArea);
        }

        // G√°n s·ª± ki·ªán cho n√∫t "X√≥a h·∫øt"
        clearAllButton.addEventListener('click', () => {
            inputText.value = '';
            outputText.value = '';
        });

        // H√†m hi·ªÉn th·ªã th√¥ng b√°o nhanh
        function showToast() {
            toast.classList.remove('opacity-0', 'translate-y-3');
            toast.classList.add('opacity-100', 'translate-y-0');
            setTimeout(() => {
                toast.classList.remove('opacity-100', 'translate-y-0');
                toast.classList.add('opacity-0', 'translate-y-3');
            }, 2000);
        }

    </script>
    <script>
        // --- SCRIPT CH√çNH CHO ·ª®NG D·ª§NG ---
        document.addEventListener('DOMContentLoaded', function() {
            const navButtons = document.querySelectorAll('.nav-btn');
            const contentFrame = document.getElementById('content-frame');
            const installButton = document.getElementById('install-button');
            let deferredPrompt;

            // --- X·ª≠ l√Ω ƒëi·ªÅu h∆∞·ªõng ---
            function selectPage(buttonToActivate) {
                const pageUrl = buttonToActivate.dataset.page;
                if (!pageUrl) return;
                contentFrame.src = pageUrl;
                navButtons.forEach(button => button.classList.remove('active'));
                buttonToActivate.classList.add('active');
            }

            navButtons.forEach(button => {
                button.addEventListener('click', function() { selectPage(this); });
            });
            
            // T·∫£i trang home.html m·∫∑c ƒë·ªãnh khi m·ªü ·ª©ng d·ª•ng
            const defaultButton = document.querySelector('button[data-page="home.html"]');
            if (defaultButton) {
                selectPage(defaultButton);
            }

            // --- X·ª≠ l√Ω c√†i ƒë·∫∑t PWA ---
            window.addEventListener('beforeinstallprompt', (e) => {
                // NgƒÉn tr√¨nh duy·ªát hi·ªÉn th·ªã th√¥ng b√°o m·∫∑c ƒë·ªãnh
                e.preventDefault();
                // L∆∞u l·∫°i s·ª± ki·ªán ƒë·ªÉ c√≥ th·ªÉ d√πng sau
                deferredPrompt = e;
                // Hi·ªÉn th·ªã n√∫t c√†i ƒë·∫∑t t√πy ch·ªânh c·ªßa ch√∫ng ta
                installButton.style.display = 'block';
            });

            installButton.addEventListener('click', async () => {
                if (deferredPrompt) {
                    installButton.style.display = 'none'; // ·∫®n n√∫t ƒëi
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log(`User response to the install prompt: ${outcome}`);
                    deferredPrompt = null;
                }
            });

            window.addEventListener('appinstalled', () => {
                installButton.style.display = 'none';
                deferredPrompt = null;
                console.log('PWA was installed');
            });

            // --- ƒêƒÉng k√Ω Service Worker ---
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/sw.js').then(registration => {
                        console.log('Service Worker registered: ', registration);
                    }).catch(error => {
                        console.log('Service Worker registration failed: ', error);
                    });
                });
            }
        });
    </script>
</body>
</html>
